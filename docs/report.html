<html><head><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/solarized-dark.min.css"/><link href="https://jasonm23.github.io/markdown-css-themes/swiss.css" rel="stylesheet"></head><body><h1 id="暗号化プログラミングレポート">暗号化プログラミングレポート</h1>
<h1 id="目的">目的</h1>
<ul>
<li>広く利用されているAES暗号の暗号化プログラムを実装することで、対称ブロック暗号(symmetric block cipher)について学ぶ。</li>
<li>平文と暗号文の線形性を壊すために、離散数学(ガロア体理論に基づくバイト演算)が応用されていることを学ぶ。</li>
<li>暗号化で不可欠なビット演算のプログラミングを学ぶ。</li>
<li>事前計算(precalculation)とルックアップテーブル(lookup table)を利用した高速化を学ぶ。</li>
</ul>
<hr>
<h2 id="実行環境">実行環境</h2>
<p>Dockerを用いて実験の環境を構築した。比較のためにネイティブで動作するUbuntuでも動作の確認をした。</p>
<ol>
<li><p>OS: macOS 12.0.1 21A558 arm64</p>
<ul>
<li>Docker: 20.10.8, build 3967b7d<ul>
<li>カーネル: 5.10.47-linuxkit</li>
<li>bash: 5.0.17</li>
<li>cc: (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0</li>
<li>make: GNU Make 4.2.1</li>
</ul>
</li>
</ul>
</li>
<li><p>OS: Ubuntu 20.04.2 LTS x86_6</p>
<ul>
<li>カーネル: 5.8.0-63-generic</li>
<li>bash: 5.0.17</li>
<li>cc: (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0</li>
<li>make: GNU Make 4.2.1</li>
</ul>
</li>
</ol>
<p>コンテナは次のファイルを用い、フラグとして<code>--platform=&#39;linux/amd64&#39;</code>を指定しビルドした。</p>
<pre><code class="Dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:latest
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /home</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> apt update &amp;&amp; \
    apt upgrade -y &amp;&amp; \
    apt install gcc make -y</span>
<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/usr/bin/bash&quot;</span>,<span class="hljs-string">&quot;-l&quot;</span>]</span>
</code></pre>
<hr>
<h1 id="実験i">実験I</h1>
<h2 id="作成したプログラム">作成したプログラム</h2>
<p>以下に示すのは<code>Multiply</code>関数、<code>Inverse</code>関数、<code>Affine</code>関数を含む<code>aes.c</code>のプログラム全体である。</p>
<pre><code class="cc"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;aes128.h&quot;</span></span>

<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">Multiply</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> x, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> y)</span> </span>{
  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> z = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">while</span> (y != <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (y % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
      z ^= x;
    }
    y = y &gt;&gt; <span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">0x80</span>) {
      x &lt;&lt;= <span class="hljs-number">1</span>;
      x ^= <span class="hljs-number">0x1B</span>;
    } <span class="hljs-keyword">else</span> {
      x &lt;&lt;= <span class="hljs-number">1</span>;
    }
  }
  <span class="hljs-keyword">return</span> z;
}

<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">Inverse</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> b)</span> </span>{
  <span class="hljs-type">double</span> b2, b4, b8, b16, b32, b64, b128, b254;

  b2 = <span class="hljs-built_in">Multiply</span>(b, b);
  b4 = <span class="hljs-built_in">Multiply</span>(b2, b2);
  b8 = <span class="hljs-built_in">Multiply</span>(b4, b4);
  b16 = <span class="hljs-built_in">Multiply</span>(b8, b8);
  b32 = <span class="hljs-built_in">Multiply</span>(b16, b16);
  b64 = <span class="hljs-built_in">Multiply</span>(b32, b32);
  b128 = <span class="hljs-built_in">Multiply</span>(b64, b64);
  b254 = <span class="hljs-built_in">Multiply</span>(
      <span class="hljs-built_in">Multiply</span>(<span class="hljs-built_in">Multiply</span>(<span class="hljs-built_in">Multiply</span>(<span class="hljs-built_in">Multiply</span>(<span class="hljs-built_in">Multiply</span>(b2, b4), b8), b16), b32),
               b64),
      b128);
  <span class="hljs-keyword">return</span> b254;
}

<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">Affine</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> b)</span> </span>{
  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> result_matrix[<span class="hljs-number">8</span>];
  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> result_bytes = <span class="hljs-number">0</span>, b4, b2, b1;

  result_matrix[<span class="hljs-number">0</span>] = <span class="hljs-number">0xF1</span> &amp; b;
  result_matrix[<span class="hljs-number">1</span>] = <span class="hljs-number">0xE3</span> &amp; b;
  result_matrix[<span class="hljs-number">2</span>] = <span class="hljs-number">0xC7</span> &amp; b;
  result_matrix[<span class="hljs-number">3</span>] = <span class="hljs-number">0x8F</span> &amp; b;

  result_matrix[<span class="hljs-number">4</span>] = <span class="hljs-number">0x1F</span> &amp; b;
  result_matrix[<span class="hljs-number">5</span>] = <span class="hljs-number">0x3E</span> &amp; b;
  result_matrix[<span class="hljs-number">6</span>] = <span class="hljs-number">0x7C</span> &amp; b;
  result_matrix[<span class="hljs-number">7</span>] = <span class="hljs-number">0xF8</span> &amp; b;

  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> idx = <span class="hljs-number">7</span>; idx &gt;= <span class="hljs-number">0</span>; idx--) {
    b4 = (result_matrix[idx] &gt;&gt; <span class="hljs-number">4</span>) ^ result_matrix[idx];
    b2 = (b4 &gt;&gt; <span class="hljs-number">2</span>) ^ b4;
    b1 = (b2 &gt;&gt; <span class="hljs-number">1</span> ^ b2) &amp; <span class="hljs-number">0x01</span>;
    result_bytes = b1 ^ (result_bytes &lt;&lt; <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> result_bytes ^ <span class="hljs-number">0x63</span>;
}
</code></pre>
<h2 id="利用したinverseのアルゴリズム">利用した<code>Inverse</code>のアルゴリズム</h2>
<p>上記の<code>aes.c</code>に示した通り、Inverse関数のアルゴリズムとして、資料に示されてる「計算方法2」を使用した。</p>
<h2 id="affine関数のフローチャート"><code>Affine</code>関数のフローチャート</h2>
<p><img src="mdbin/img/affine_fc.png" alt="Affine関数フローチャート"></p>
<h2 id="multiplyアルゴリズムの正当性"><code>Multiply</code>アルゴリズムの正当性</h2>
<h2 id="4バイトデータと1ワードデータの双方向変換のunionによる実現">4バイトデータと1ワードデータの双方向変換の<code>union</code>による実現</h2>
<p>keyexpand.cでは、4バイトデータと1ワードデータの相互変換をaes128.hで定義される<code>key_t</code>型のunion(共用体)変数を用いて行っている。</p>
<p>C言語においてunionとは、同じメモリ領域を複数の型の変数が共有する共用体のデータ構造である。</p>
<p><code>key_t</code>型では<code>unsigned long int</code>型の<code>word</code>(32ビット)と<code>unsigned char[4]</code>型の<code>byte</code>(8ビット*4)が同じメモリ領域を共有している。
unionの初期化は先頭のメンバ変数の型で行われるため、<code>key_t</code>型の場合、メモリ上に32ビットの連続した領域が確保される。</p>
<p>例えば<code>0x12345678</code>というデータで<code>key_t</code>型の変数<code>x</code>を初期化すると、<code>x.word</code>でワードデータとして、
<code>x.byte[1]</code>で2バイト目のデータ(0x34)を得ることができる。</p>
<hr>
<h1 id="実験ii">実験II</h1>
<h2 id="作成したプログラム-1">作成したプログラム</h2>
<h3 id="ルックアップテーブルの出力">ルックアップテーブルの出力</h3>
<p>ルックアップテーブル<code>sbox.c</code>,<code>mbox02.c</code>,<code>mbox03.c</code>を生成するプログラムとして、
<code>gen_sbox.c</code>,<code>gen_mbox02.c</code>,<code>gen_mbox03.c</code>を作成した。</p>
<p>以下が作成したプログラムの内容である。</p>
<ul>
<li><code>gen_sbox.c</code></li>
</ul>
<pre><code class="cc"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;aes128.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unsigned char sbox[256] = {&quot;</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> b = <span class="hljs-number">0</span>; b &lt;= <span class="hljs-number">254</span>; b++) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02X, &quot;</span>, <span class="hljs-built_in">Affine</span>(<span class="hljs-built_in">Inverse</span>(b)));
  }
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02X };\n&quot;</span>, <span class="hljs-built_in">Affine</span>(<span class="hljs-built_in">Inverse</span>(<span class="hljs-number">255</span>)));
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<ul>
<li><code>gen_mbox02.c</code></li>
</ul>
<pre><code class="cc"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;aes128.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unsigned char mbox02[256] = {&quot;</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> b = <span class="hljs-number">0</span>; b &lt;= <span class="hljs-number">254</span>; b++) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02X, &quot;</span>, <span class="hljs-built_in">Multiply</span>(b, <span class="hljs-number">0x02</span>));
  }
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02X };\n&quot;</span>, <span class="hljs-built_in">Multiply</span>(<span class="hljs-number">255</span>, <span class="hljs-number">0x02</span>));
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<ul>
<li><code>gen_mbox03.c</code></li>
</ul>
<pre><code class="cc"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;aes128.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unsigned char mbox03[256] = {&quot;</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> b = <span class="hljs-number">0</span>; b &lt;= <span class="hljs-number">254</span>; b++) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02X, &quot;</span>, <span class="hljs-built_in">Multiply</span>(b, <span class="hljs-number">0x03</span>));
  }
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02X };\n&quot;</span>, <span class="hljs-built_in">Multiply</span>(<span class="hljs-number">255</span>, <span class="hljs-number">0x03</span>));
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>以上のプログラムを次に抜粋して示すMakefileでコンパイルしルックアップテーブルを生成した。</p>
<pre><code class="Makefile">SHELL = /bin/bash
CC = /bin/cc
BIN = ./bin

<span class="hljs-comment"># 実験2: 配列コード生成</span>
<span class="hljs-section">gen_boxes: gen_sbox gen_mbox02 gen_mbox03</span>
    @<span class="hljs-variable">$(BIN)</span>/gen_sbox &gt; sbox.c
    @<span class="hljs-variable">$(BIN)</span>/gen_mbox02 &gt; mbox02.c
    @<span class="hljs-variable">$(BIN)</span>/gen_mbox03 &gt; mbox03.c
    @<span class="hljs-variable">$(CC)</span> -c sbox.c
    @<span class="hljs-variable">$(CC)</span> -c mbox02.c
    @<span class="hljs-variable">$(CC)</span> -c mbox03.c

<span class="hljs-section">gen_sbox: gen_sbox.o aes.o</span>
    <span class="hljs-variable">$(CC)</span> -o <span class="hljs-variable">$(BIN)</span>/gen_sbox \
        gen_sbox.o aes.o

<span class="hljs-section">gen_mbox02: gen_mbox02.o aes.o</span>
    <span class="hljs-variable">$(CC)</span> -o <span class="hljs-variable">$(BIN)</span>/gen_mbox02 \
         gen_mbox02.o aes.o

<span class="hljs-section">gen_mbox03: gen_mbox03.o aes.o</span>
    <span class="hljs-variable">$(CC)</span> -o <span class="hljs-variable">$(BIN)</span>/gen_mbox03 \
         gen_mbox03.o aes.o
</code></pre>
<p>以上のプログラムをそれぞれコンパイルし実行ファイル</p>
<h3 id="高速化したsubbytes関数mixcolumns関数">高速化した<code>SubBytes</code>関数,<code>MixColumns</code>関数</h3>
<p>上記に示したルックアップテーブルを用い、高速化を図った
<code>SubBytes</code>関数と<code>MixColumns</code>関数をそれぞれ
<code>subbytes_lut.c</code>,<code>mixcolumns_lut.c</code>に作成した。</p>
<h2 id="事前計算で得られたsboxの値：">事前計算で得られた<code>sbox</code>の値：</h2>
<h2 id="事前計算で得られたmbox02mbox03の値：">事前計算で得られた<code>mbox02,mbox03</code>の値：</h2>
<h2 id="高速化率">高速化率</h2>
<hr>
<h1 id="考察">考察</h1>
</body></html>
